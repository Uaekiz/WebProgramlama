@model webApplication.Models.Hall

@{
    var reservations = ViewBag.Reservations as List<webApplication.Models.Reservation>; //we create the list and confirm the filter
    DateTime? selectedStart = ViewBag.SelectedStart;
    DateTime? selectedEnd = ViewBag.SelectedEnd;
    bool filterApplied = ViewBag.FilterApplied ?? false;
}

<style>
    .seat-grid {
        display: grid;
        grid-template-columns: repeat(5, 70px);
        gap: 18px;
        justify-content: center;
        margin-top: 30px;
    }

    .seat {
        width: 50px;
        height: 50px;
        border-radius: 18px;
        padding-top: 18px;
        font-size: 20px;

        background: linear-gradient(#4caf50, #2e8b57);
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;

        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.35);
        transition: transform 0.2s ease;
    }


    .seat::before {
        content: "";
        position: absolute;
        top: -10px;
        width: 45px;
        height: 18px;
        border-radius: 10px;
        background: inherit;
        box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.30);
    }

    .seat::after {
        content: "";
        position: absolute;
        bottom: -10px;
        width: 60%;
        height: 8px;
        background: rgba(0, 0, 0, 0.35);
        border-radius: 50%;
        filter: blur(3px);
    }



    .seat:hover {
        transform: scale(1.08);
    }

    .seat.available {
        background: linear-gradient(145deg, #34d977, #25a85c);
    }

    .seat.available:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.30);
    }

    .seat.reserved {
        background: linear-gradient(145deg, #e74c3c, #b63728);
        cursor: not-allowed;
    }

    .table-row {
        grid-column: 1 / -1;
        height: 45px;
        background: linear-gradient(#dcdcdc, #bfbfbf);
        border-radius: 8px;
        margin: 12px 0 22px 0;

        box-shadow:
            inset 0 2px 4px rgba(255, 255, 255, 0.5),
            inset 0 -3px 6px rgba(0, 0, 0, 0.25),
            0 4px 10px rgba(0, 0, 0, 0.25);
    }

    .info-box {
        background: #162533;
        padding: 15px;
        border-radius: 10px;
        border-left: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
        font-size: 16px;
        margin-bottom: 20px;
    }

    .info-box strong {
        color: #e95d2c;
    }

    .btn-filtrele-turuncu {
        background-color: #e95d2c !important;
        border-color: #e95d2c !important;
        color: #ffffff !important;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }

    .btn-filtrele-turuncu:hover {
        background-color: #a63e1b !important;
        border-color: #a63e1b !important;
        color: #ffffff !important;
    }

    h2,
    label {
        color: #ffffff;
    }

    select.form-control {
        height: 45px;
        border-radius: 5px;
        cursor: pointer;
    }
</style>

<h2>@Model.Name</h2>

@if (DateTime.Now.Hour >= 23)
{
    //if it is after 23.00 it is closed so user cant choose a time after that time
    <div class="alert alert-danger shadow-sm text-center border-0" style="background-color: #ffcccc; color: #cc0000;">
        <h5 class="mb-1"><i class="bi bi-moon-stars-fill"></i> Rezervasyon Saati Doldu</h5>
        <p class="mb-0">
            Saat <strong>23:00</strong>'ı geçtiği için bugün adına yeni rezervasyon oluşturulamaz.
            Lütfen aşağıdaki tarih kutusundan <strong>Yarın</strong> seçeneğini işaretleyerek devam ediniz.
        </p>
    </div>
}
<p>Koltuk sayısı: @Model.SeatCount</p>

@if (TempData["SuccessMessage"] != null)
{
    //for success messsage
    <div class="alert alert-success" style="font-size:16px; padding:12px;">
        @TempData["SuccessMessage"]
    </div>
    return; //dont continue
}


@if (!filterApplied)
{
    <div class="info-box">
        Lütfen rezervasyon yapmak istediğiniz
        <strong>tarih</strong> ve <strong>saat </strong> aralığını seçin. Ardından boş (yeşil)
        koltuklara tıklayarak seçim yapabilirsiniz.

    </div>
}

<form method="get" style="margin-bottom:20px;">
    <input type="hidden" name="id" value="@Model.Id" />

    <div class="form-group">
        <label>Tarih seçiniz</label>
        <select name="date" class="form-control" onchange="this.form.submit()">
            @{
                string bugun = DateTime.Today.ToString("yyyy-MM-dd"); //we are formatting todays and tomorrows dates as strings in yyyy-MM-dd format
                string yarin = DateTime.Today.AddDays(1).ToString("yyyy-MM-dd");

                string secilenTarih = ViewBag.SelectedDateString as string;
            }

            <!option value="@bugun" @(secilenTarih == bugun ? "selected" : "")>
                Bugün (@DateTime.Today.ToString("dd.MM.yyyy"))
            </!option>

            <!option value="@yarin" @(secilenTarih == yarin ? "selected" : "")>
                Yarın (@DateTime.Today.AddDays(1).ToString("dd.MM.yyyy"))
            </!option>
        </select>
    </div>

    <div class="form-group" style="margin-top:10px;">
        <label>Başlangıç saati</label>
        <select id="startTime" name="startTime" class="form-control">
            <option value="">Saat Seçiniz</option>

            @{
                string urlTarih = ViewBag.SelectedDateString as string ?? DateTime.Today.ToString("yyyy-MM-dd");

                bool bugunMu = (urlTarih == DateTime.Today.ToString("yyyy-MM-dd"));

                int suankiSaat = DateTime.Now.Hour;
            }

            @for (int i = 9; i < 24; i++) //it is for the list the hours between 9 an 24
            {
                if (bugunMu && i <= suankiSaat)
                {
                    continue;
                }

                string saat = i.ToString("00") + ":00";
                string secilenSaat = ViewBag.SelectedStartString as string;

                <option value="@saat" selected="@(secilenSaat == saat)">
                    @saat
                </option>
            }
        </select>
    </div>

    <div class="form-group" style="margin-top:10px;">
        <label>Bitiş saati</label>
        <input type="time" id="endTime" name="endTime" class="form-control"
            value="@(filterApplied? selectedEnd?.ToString("HH:mm") : "")" required readonly />
    </div>

    <button class="btn btn-filtrele-turuncu mt-2">Filtrele</button>
</form>

<hr />

@if (filterApplied)
{
    <div class="seat-grid">
        @{
            int index = 0;
        }

        @foreach (var seat in Model.Seats) //this loop for the show seats
        {
            index++;

            bool isReserved = false;

            if (selectedStart.HasValue && selectedEnd.HasValue)
            {
                isReserved = reservations.Any(r =>
                r.SeatId == seat.Id &&
                r.StartTime < selectedEnd &&
                r.EndTime > selectedStart
                );
            }

            string cssClass = isReserved ? "seat reserved" : "seat available"; //for red or green colour which is needed to understand empty or reserved and under the long string for create function
            string message = isReserved ? "Bu saat aralığında dolu" : "Rezerve etmek için tıklayın";

            <div class="@cssClass" title="@message"
                onclick="@(isReserved ? "" :
                                         $"window.location='/Reservation/Create?seatId={seat.Id}&date={selectedStart?.ToString("yyyy-MM-dd")}&startTime={selectedStart?.ToString("HH:mm")}&endTime={selectedEnd?.ToString("HH:mm")}'")">
                @seat.SeatNumber
            </div>

            <!-- Her 5 koltuktan sonra masa -->
            @if (index % 5 == 0)
            {
                <div class="table-row"></div>
            }
        }
    </div>
}

@section Scripts {
    <script>
        //this script is needed to otomaticly assing the finish time one hour later after start time
        document.getElementById("startTime").addEventListener("change", function () {
            let secilenSaat = this.value;

            if (secilenSaat) {
                let saatSayisi = parseInt(secilenSaat.substring(0, 2));

                let bitisSaati = saatSayisi + 1;

                if (bitisSaati === 24) bitisSaati = 0;

                let formatliBitis = bitisSaati.toString().padStart(2, '0') + ":00";

                document.getElementById("endTime").value = formatliBitis;
            } else {
                document.getElementById("endTime").value = "";
            }
        });
    </script>
}